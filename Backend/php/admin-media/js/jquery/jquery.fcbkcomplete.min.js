(function(a){a.fn.extend({fcbkcomplete:function(b){b=a.extend({},a.FCBKCompleter.defaults,b);if(b.class_names!==a.FCBKCompleter.default_class_names){b.class_names=a.extend({},a.FCBKCompleter.default_class_names,b.class_names)}return this.each(function(){new a.FCBKCompleter(this,b)})}});a.FCBKCompleter=function(b,y){var D={UP:38,DOWN:40,DEL:46,TAB:9,RETURN:13,ESC:27,COMMA:188,PAGEUP:33,PAGEDOWN:34,BACKSPACE:8,FORWARD_SLASH:191};var G=null;var f=null;var r=null;var c=0;var m=new Array();var l=false;var E="";var B=null;var A=0;var z="\v"=="v";var K;var q=a(b);var d=q.attr("id")||"fcbkselect_ "+Math.floor(Math.random()*100000);var j=null;var b=null;var k=new Array();var x=(y.used_vals!=undefined&&a.isArray(y.used_vals))?y.used_vals:[];e();o();s();n(false);L();q.data("setSelected",function(N,M){var O=a.inArray(N,k);if(M&&O<0){k.push(N)}else{if(!M&&O>-1){k.splice(O,1)}}});a(this).bind("addItem",function(N,O){if(a.isArray(O)){for(var M=0;M<O.length;M++){H(O[M].title,O[M].value,0,0,0)}}else{H(O.title,O.value,0,0,0)}});function e(){if(q.context.tagName.toUpperCase()!="SELECT"){var M=q[0].id;var N=a(document.createElement("select"));N.attr("name",q[0].name);q.replaceWith(N);q=N;q.attr("id",M)}q.hide();if(y.maxitems>1){q.attr("multiple","multiple")}if(y.php_mode&&q.attr("name").indexOf("[]")==-1){q.attr("name",q.attr("name")+"[]")}G=a(document.createElement("ul"));G.attr("class",y.class_names.holder);q.after(G);r=a(document.createElement("div"));r.addClass(y.class_names.complete);if(y.complete_text){r.append('<div class="default">'+y.complete_text+"</div>")}if(z){r.append('<iframe class="ie6fix" scrolling="no" frameborder="0"></iframe>');K=r.children(".ie6fix")}f=a(document.createElement("ul"));f.attr("id",d+"_feed");r.prepend(f);G.after(r);if(y.force_width){f.css("width",y.width)}else{if(y.auto_width){f.css("width",r.width())}}}function o(){if(y.data&&a.isArray(y.data)){a.each(y.data,function(M,N){m.push({caption:N.name,value:N.id});x.push(N.id)})}else{q.children("option").each(function(M,N){N=a(N);if(y.maxitems>1){if(N.hasClass("selected")||N.is(":selected")){H(N.text(),N.val(),true,N.hasClass(y.class_names.item_locked));N.attr("selected","selected");x.push(N.val())}}else{N.removeAttr("selected")}m.push({caption:N.text(),value:N.val()});E+=""+(m.length-1)+":"+N.text()+";"})}}function s(){setTimeout(function(){var M=r.prev();var N=M.position();r.css({top:N.top+M.outerHeight(true),position:"absolute","z-index":y.zIndex,left:N.left})},0)}function p(N,M){if(y.connect_with){a(y.connect_with).each(function(){if(this!=q[0]){var O=a(this).data("setSelected");if(typeof O=="function"){O(N,M)}}})}}function H(R,S,O,M,U){if(!F()){return false}var T=document.createElement("li");var N=document.createTextNode(R);var Q=document.createElement("a");a(T).attr({"class":y.class_names.item_default,rel:S});a(T).prepend(N);a(Q).attr({"class":y.class_names.closebutton,href:"#"});if(M){a(T).addClass(y.class_names.item_locked)}T.appendChild(Q);G.append(T);a(Q).click(function(){i(a(this).parent("li"));return false});if(!O){j.remove();var P;n(U);if(q.children("option[value="+S+"]").length){P=q.children("option[value="+S+"]");P.get(0).setAttribute("selected","selected");if(!P.hasClass("selected")){P.addClass("selected")}}else{var P=a(document.createElement("option"));P.attr("value",S).get(0).setAttribute("selected","selected");P.attr("value",S).addClass("selected");P.text(R);q.append(P)}if(y.connect_with=="Array"&&a.inArray(S,x)<0){x.push(S.toString())}else{if(y.connect_with&&y.connect_with!="Array"){p(S.toString(),true)}}if(typeof y.onselect=="function"){v(y.onselect,P)}q.change()}G.children("li."+y.class_names.item_default+".deleted").removeClass("deleted");f.hide();z?K.hide():""}function i(N){if(!N.hasClass(y.class_names.item_locked)){N.fadeOut("fast");var O=N.attr("rel");if(y.connect_with=="Array"){var P=a.inArray(O,x);if(P>-1){x.splice(P,1)}}else{if(y.connect_with&&y.connect_with!="Array"){p(O,false)}}if(typeof y.onremove=="function"){var M=q.children("option[value="+O+"]");v(y.onremove,M)}q.children('option[value="'+N.attr("rel")+'"]').removeAttr("selected").removeClass("selected");N.remove();q.change();A=0}}function n(M){j=a(document.createElement("li"));b=a(document.createElement("input"));j.attr({"class":"bit-input",id:d+"_annoninput"});b.attr({type:"text","class":"maininput",size:"1",autocomplete:"off"});G.append(j.append(b));var N=0;b.focus(function(){r.fadeIn("fast")});b.blur(function(){r.fadeOut("fast")});G.click(function(){s();b.focus();if(f.length&&(b.val().length||y.default_search.length)){if(y.default_search.length&&!b.val().length){b.keyup()}f.show()}else{f.hide();z?K.hide():"";r.children(".default").show()}});b.keypress(function(O){if(O.keyCode==D.RETURN||O.keyCode==D.TAB){return true}b.attr("size",b.val().length+1)});b.keydown(function(O){if(O.keyCode==D.FORWARD_SLASH){O.preventDefault();return false}});b.keyup(function(P){var O=b.val();var S=J(O==""?y.default_search:O);if(P.keyCode==D.BACKSPACE&&S==y.default_search){f.hide();z?K.hide():"";if(!G.children("li."+y.class_names.item_default+":last").hasClass(y.class_names.item_locked)){if(G.children("li."+y.class_names.item_default+".deleted").length==0){G.children("li."+y.class_names.item_default+":last").addClass("deleted");return false}else{if(A){return}A=1;G.children("li."+y.class_names.item_default+".deleted").fadeOut("fast",function(){i(a(this));return false})}}}if(P.keyCode!=D.DOWN&&P.keyCode!=D.UP&&S.length!=0){c=0;if(y.json_url){if(y.cache&&l){g(S);I()}else{N++;var R=N;setTimeout(function(){if(R!=N){return}a.getJSON(y.json_url+(y.json_url.indexOf("?")>-1?"&":"?")+"tag="+S,null,function(T){g(S,T);l=true;I()})},y.delay)}}else{var Q=undefined;if(y.preset_update){Q=new Array();q.children("option").each(function(T,U){U=a(U);if(U.is(":selected")||U.is(".selected")){return undefined}Q.push({caption:U.text(),value:U.val()})})}g(S,Q);I()}s();r.children(".default").hide();f.show()}});if(M){setTimeout(function(){b.focus();s();r.children(".default").show()},1)}}function g(N,R){f.html("");N=N==""?y.default_search:N;if(!y.cache&&R!=null){m=new Array();E=""}if(y.default_search!=N){h(N)}if(R!=null&&R.length){a.each(R,function(Y,Z){m.push({caption:Z.caption,value:Z.value});E+=""+(m.length-1)+":"+Z.caption+";"})}var Q=y.maxshownitems<m.length?y.maxshownitems:m.length;var O="i";if(y.filter_case){O=""}var X,T;try{X=new RegExp("(?:^|;)\\s*(\\d+)\\s*:[^;]*?"+N+"[^;]*","g"+O);T=X.exec(E)}catch(W){}var U="";while(T!=null&&Q>0){var M=T[1];var P=m[M];var S=a.inArray(P.value.toString(),k);if(S<0&&y.connect_with=="Array"){S=a.inArray(P.value.toString(),x)}if(S<0){var V=q.children("option[value="+P.value+"]");if(V.length==0){V=q.children(":contains('"+P.value+"')")}S=(V.length>0&&y.filter_selected&&(V.is(".selected")||V.is(":selected")))}else{S=true}if(!S){U+='<li rel="'+P.value+'">'+C(P.caption,N)+"</li>";c++;Q--}T=X.exec(E)}f.append(U);if(y.firstselected){B=f.children("li:first");B.addClass("auto-focus")}if(c>y.height){f.css({height:(y.height*24)+"px",overflow:"auto"});if(z){if(y.auto_width){K.css({width:f.width()+"px"})}K.css({height:(y.height*24)+"px"}).show()}}else{f.css("height","auto");if(z){if(y.auto_width){K.css({width:f.width()+"px"})}K.css({height:f.height()+"px"}).show()}}}function L(P){var N=a(y.layer_selector);if(N!=null&&N.length>0){var M=0;var O=a(P);a(y.layer_selector).each(function(){var Q=parseInt(a(this).css("z-index"));if(O[0]!=this&&Q>M){M=Q}});O.css({"z-index":(M+1)})}}function C(N,O){if(y.filter_case){try{var N=N.replace(new RegExp('(.*)("'+O+'")(.*)',"gi"),"$1<em>$2</em>$3")}catch(M){}}else{try{var N=N.replace(new RegExp('(.*)("'+O.toLowerCase()+'")(.*)',"gi"),"$1<em>$2</em>$3")}catch(M){}}return N}function t(){f.children("li").mouseover(function(){f.children("li").removeClass("auto-focus");a(this).addClass("auto-focus");B=a(this)});f.children("li").mouseout(function(){a(this).removeClass("auto-focus");B=null})}function w(){f.children("li").unbind("mouseover");f.children("li").unbind("mouseout");f.mousemove(function(){t();f.unbind("mousemove")})}function I(){var M=j.children(".maininput");t();f.children("li").unbind("mousedown");f.children("li").mousedown(function(){var N=a(this);H(N.text(),N.attr("rel"));f.hide();z?K.hide():"";r.hide()});M.unbind("keydown");M.keydown(function(Q){if(Q.keyCode==D.FORWARD_SLASH){Q.preventDefault();return false}if(Q.keyCode!=D.BACKSPACE){G.children("li."+y.class_names.item_default+".deleted").removeClass("deleted")}if((Q.keyCode==D.RETURN&&y.choose_on_enter)||(Q.keyCode==D.TAB&&y.choose_on_tab)||(Q.keyCode==D.COMMA&&y.choose_on_comma)){if(u()){var O=B;H(O.text(),O.attr("rel"));r.hide();Q.preventDefault();B=null;if(y.keep_prompt_after_choose){G.trigger("click")}return false}else{if(y.newel){var R=J(a(this).val());if(R){H(R,R);Q.preventDefault();b.focus()}else{r.hide()}B=null}if(y.keep_prompt_after_choose){G.trigger("click")}return false}}if(Q.keyCode==D.DOWN){w();if(B==null||B.length==0){B=f.children("li:first");f.get(0).scrollTop=0}else{B.removeClass("auto-focus");B=B.next();var P=parseInt(B.prevAll("li").length);var N=parseInt(B.nextAll("li").length);if((P>Math.round(y.height/2)||N<=Math.round(y.height/2))&&typeof(B.get(0))!="undefined"){f.get(0).scrollTop=parseInt(B.get(0).scrollHeight,10)*(P-Math.round(y.height/2))}}f.children("li").removeClass("auto-focus");B.addClass("auto-focus")}if(Q.keyCode==D.UP){w();if(B==null||B.length==0){B=f.children("li:last");f.get(0).scrollTop=parseInt(B.get(0).scrollHeight)*(parseInt(f.children("li").length)-Math.round(y.height/2))}else{B.removeClass("auto-focus");B=B.prev();var P=parseInt(B.prevAll("li").length);var N=parseInt(B.nextAll("li").length);if((N>Math.round(y.height/2)||P<=Math.round(y.height/2))&&typeof(B.get(0))!="undefined"){f.get(0).scrollTop=parseInt(B.get(0).scrollHeight)*(P-Math.round(y.height/2))}}f.children("li").removeClass("auto-focus");B.addClass("auto-focus")}})}function F(){return(y.maxitems>0&&G.children("li."+y.class_names.item_default).length<y.maxitems)}function h(N){if(y.newel&&F()){f.children("li[fckb=1]").remove();if(N.length==0){return}var M=a(document.createElement("li"));M.attr({rel:N,fckb:"1"}).html(N);f.prepend(M);c++}}function v(O,N){var P={};for(var M=0;M<N.get(0).attributes.length;M++){if(N.get(0).attributes[M].nodeValue!=null){P["_"+N.get(0).attributes[M].nodeName]=N.get(0).attributes[M].nodeValue}}O.call(q[0],P)}function u(){return !(B==null||B.length==0)}function J(M){M=M.replace(/[\"\'][\s]*javascript:(.*)[\"\']/g,'""');M=M.replace(/script(.*)/g,"");M=M.replace(/eval\((.*)\)/g,"");M=M.replace("/([\x00-\x08,\x0b-\x0c,\x0e-\x19])/","");return M}};a.FCBKCompleter.default_class_names={holder:"holder",complete:"facebook-auto",closebutton:"closebutton",item_default:"bit-box",item_locked:"locked"};a.FCBKCompleter.defaults={json_url:null,cache:false,height:"10",newel:false,firstselected:false,filter_case:false,filter_hide:false,complete_text:"Start to type...",default_search:".*?",maxshownitems:30,preset_update:true,maxitems:10,data:false,connect_with:false,onselect:null,onremove:null,delay:10,zIndex:1,used_vals:new Array(),force_width:null,auto_width:true,choose_on_comma:true,choose_on_tab:true,choose_on_enter:true,keep_prompt_after_choose:true,layer_selector:"",php_mode:true,class_names:a.FCBKCompleter.default_class_names}})(jQuery);